<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UK & US Cities Map with Info and Fly Buttons</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" />
  <!-- Bootstrap CSS (for styling and the filter panel) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" />
  <!-- Leaflet Awesome Markers CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    /* Filter panel styling */
    #filter-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      max-height: 90%;
      overflow-y: auto;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <!-- Map Container -->
  <div id="map"></div>
  
  <!-- Filter Panel -->
  <div id="filter-panel">
    <h5>Filter Markers</h5>
    <div>
      <strong>US States:</strong>
      <div id="us-states-filter">
        <!-- Checkboxes will be generated here -->
      </div>
    </div>
    <div class="mt-2">
      <input type="checkbox" id="toggleUK" checked>
      <label for="toggleUK">Show UK markers</label>
    </div>
  </div>

  <!-- Scripts -->
  <!-- jQuery (for convenience) -->
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <!-- Bootstrap Bundle JS (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
  <!-- Leaflet Awesome Markers JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
  
  <script>
    /*************************************
     * Global Variables & Custom Icons   *
     *************************************/
    var defaultIconUS = L.AwesomeMarkers.icon({
      icon: 'info-sign',
      markerColor: 'blue',
      prefix: 'glyphicon'
    });
    var defaultIconUK = L.AwesomeMarkers.icon({
      icon: 'info-sign',
      markerColor: 'red',
      prefix: 'glyphicon'
    });
    var highlightIcon = L.AwesomeMarkers.icon({
      icon: 'star',
      markerColor: 'orange',
      prefix: 'glyphicon'
    });
    
    /******************************
     * Initialize the Leaflet Map *
     ******************************/
    var map = L.map('map').setView([39.50, -98.35], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      maxZoom: 18
    }).addTo(map);
    
    /**********************************************************
     * Global Data Structures for Marker Storage & Filtering *
     **********************************************************/
    // cityLookup[cityNameLower] = array of { marker, data }
    var cityLookup = {};
    var allMarkers = [];    // Flat array of all marker entries
    var usStatesSet = new Set(); // Collect all unique US states
    
    /********************************************************************
     * Fly To Function: Finds exact marker by lat/lng & highlights it.  *
     ********************************************************************/
    function flyToLocation(lat, lng, cityName, country) {
      console.log("flyToLocation called with:", lat, lng, cityName, country);
      map.flyTo([lat, lng], 10, { duration: 1.5 });

      // If cityName wasn't passed, just fly the map & return
      if (!cityName) return;

      var key = cityName.toLowerCase().trim();
      var entries = cityLookup[key] || [];

      // Filter by country if provided
      if (country) {
        entries = entries.filter(function(e) {
          return e.data.Country === country;
        });
      }

      // Find the entry matching the same lat/lng
      var foundEntry = entries.find(function(e) {
        return parseFloat(e.data.latitude) === parseFloat(lat) &&
               parseFloat(e.data.longitude) === parseFloat(lng);
      });

      if (foundEntry) {
        var marker = foundEntry.marker;
        var originalIcon = marker.options.icon;
        // Temporarily highlight the marker
        marker.setIcon(highlightIcon);
        setTimeout(function() {
          marker.setIcon(originalIcon);
        }, 2000);
      }
    }
    // Make global for inline onclick usage
    window.flyToLocation = flyToLocation;
    
    /********************************************
     * Helper Function: Add a Marker            *
     ********************************************/
    function addCityMarker(cityData) {
      // Some rows only have 4 columns (UK rows), so we remap
      if (cityData.longitude === undefined) {
        cityData = {
          State: "",
          City: cityData.State,
          Country: cityData.City,
          latitude: cityData.Country,
          longitude: cityData.latitude
        };
      }
      
      var lat = parseFloat(cityData.latitude);
      var lng = parseFloat(cityData.longitude);
      var cityName = cityData.City;
      console.log("Adding marker for:", cityName, cityData);
      
      // Choose the icon
      var icon = (cityData.Country === "US") ? defaultIconUS : defaultIconUK;
      var marker = L.marker([lat, lng], { icon: icon }).addTo(map);
      
      // Store in cityLookup by cityNameLower
      var key = cityName.toLowerCase().trim();
      if (!cityLookup[key]) {
        cityLookup[key] = [];
      }
      var entry = { marker: marker, data: cityData };
      cityLookup[key].push(entry);
      allMarkers.push(entry);
      
      // Record US state if available
      if (cityData.Country === "US" && cityData.State) {
        usStatesSet.add(cityData.State);
      }
      
      // On marker click, show a popup & highlight the clicked marker
      marker.on('click', function() {
        var originalIcon = marker.options.icon;
        marker.setIcon(highlightIcon);
        setTimeout(function(){
          marker.setIcon(originalIcon);
        }, 2000);

        // Build the popup
        var entries = cityLookup[key]; // all markers with same city name
        var usEntries = entries.filter(e => e.data.Country === "US");
        var ukEntries = entries.filter(e => e.data.Country === "UK");

        // 1) Popup Title: "CityName, State" (if US) or "CityName, UK" (if UK)
        var titleLine = cityData.City; // the specific marker that was clicked
        if (cityData.Country === "US" && cityData.State) {
          titleLine += ", " + cityData.State;
        } else if (cityData.Country === "UK") {
          titleLine += ", UK";
        }

        var content = "<strong>" + titleLine + "</strong><br>";
        content += "Coordinates: " + lat.toFixed(4) + ", " + lng.toFixed(4) + "<br><br>";

        // 2) If there's a US version, list them
        if (usEntries.length > 0) {
          content += "<u>US:</u><br>";
          usEntries.forEach(function(e) {
            var s = (e.data.State) ? e.data.State : "Unknown";
            content += "State: " + s + "<br>";
            // Note: pass in e.data.latitude, e.data.longitude, e.data.City, "US"
            content += "<button class='btn btn-sm btn-primary m-1' onclick='flyToLocation("
              + e.data.latitude + ", "
              + e.data.longitude + ", "
              + "\"" + e.data.City + "\", "
              + "\"US\""
              + ")'>Fly to " + s + "</button><br>";
          });
          content += "<br>";
        }

        // 3) If there's a UK version, list it
        if (ukEntries.length > 0) {
          content += "<u>UK:</u><br>";
          // Potentially multiple UK entries (same city name). Just show first or loop
          var ukCityData = ukEntries[0].data;
          content += "<button class='btn btn-sm btn-secondary m-1' onclick='flyToLocation("
            + ukCityData.latitude + ", "
            + ukCityData.longitude + ", "
            + "\"" + ukCityData.City + "\", "
            + "\"UK\""
            + ")'>Fly to UK</button>";
        }

        marker.bindPopup(content).openPopup();
      });
    }
    
    /***********************************************
     * Filtering: Update Marker Visibility         *
     ***********************************************/
    function updateMarkersVisibility() {
      // Gather which US states are checked
      var selectedStates = [];
      $('#us-states-filter input[type=checkbox]').each(function() {
        if (this.checked) {
          selectedStates.push(this.value);
        }
      });
      var showUK = $('#toggleUK').is(':checked');
      console.log("Filtering - Selected US states:", selectedStates, "Show UK:", showUK);
      
      allMarkers.forEach(function(entry) {
        var country = entry.data.Country;
        var state = entry.data.State;
        var marker = entry.marker;
        var shouldShow = false;
        
        if (country === "US") {
          // Show if the state is checked
          shouldShow = selectedStates.includes(state);
        } else if (country === "UK") {
          // Show UK marker only if user toggled UK
          // AND there is a matching US city that is shown
          var key = entry.data.City.toLowerCase().trim();
          var matchingUS = cityLookup[key].filter(function(e) {
            return e.data.Country === "US" && selectedStates.includes(e.data.State);
          });
          shouldShow = (matchingUS.length > 0) && showUK;
        }
        
        // Toggle marker on the map accordingly
        if (shouldShow) {
          if (!map.hasLayer(marker)) {
            marker.addTo(map);
          }
        } else {
          if (map.hasLayer(marker)) {
            map.removeLayer(marker);
          }
        }
      });
    }
    
    /***********************************************
     * Build the Filter Panel (US states checkboxes)
     ***********************************************/
    function buildFilterPanel() {
      var $container = $('#us-states-filter');
      var states = Array.from(usStatesSet).sort();
      states.forEach(function(state) {
        var checkboxId = 'state-' + state.replace(/\s+/g, '_');
        // Create the checkbox + label
        var $checkbox = $(
          '<input type="checkbox" id="' + checkboxId + 
          '" value="' + state + '" checked> '
        );
        var $label = $('<label for="' + checkboxId + '"> ' + state + '</label><br/>');
        $container.append($checkbox).append($label);
        
        // Listen to changes
        $checkbox.on('change', function() {
          updateMarkersVisibility();
        });
      });
      
      // Listen for UK toggle
      $('#toggleUK').on('change', function() {
        updateMarkersVisibility();
      });
    }
    
    /***********************************************
     * Load CSV & Build Markers and Filter Panel   *
     ***********************************************/
    Papa.parse("cities_with_both_coords.csv", {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function(results) {
        var data = results.data;
        // If row.longitude is undefined, it indicates a UK row with only 4 columns
        // so we do a quick remap to unify structure:
        var remappedData = data.map(function(row) {
          if (row.longitude === undefined) {
            return {
              State: "",
              City: row.State,
              Country: row.City,
              latitude: row.Country,
              longitude: row.latitude
            };
          }
          return row;
        });

        // Add a marker for each row that has lat/lng
        remappedData.forEach(function(row) {
          if (row.latitude && row.longitude) {
            addCityMarker(row);
          }
        });
        
        // Build the filter panel after all markers are created
        buildFilterPanel();
      },
      error: function(err) {
        console.error("Error loading CSV:", err);
      }
    });
  </script>
</body>
</html>
