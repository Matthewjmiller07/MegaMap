<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Responsive meta tag with shrink-to-fit -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Combined Biblical & US/UK Cities Map</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" />
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" />
  <!-- Leaflet Awesome Markers CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    /* Desktop fixed filter panel */
    #filter-panel-fixed {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1100;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      max-height: 90%;
      overflow-y: auto;
      font-size: 0.9rem;
      width: 280px;
    }
    /* Mobile offcanvas panel overrides */
    @media (max-width: 768px) {
      .offcanvas { width: 80% !important; }
      .offcanvas-body {
        max-height: calc(100vh - 60px);
        overflow-y: auto;
      }
      .leaflet-popup-content-wrapper {
        max-width: 90% !important;
        font-size: 0.85rem;
      }
      .leaflet-popup-tip {
        display: none;
      }
    }
    /* Limit popup size */
    .leaflet-popup-content {
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <!-- Map container -->
  <div id="map"></div>

  <!-- Desktop fixed filter panel (visible on large screens) -->
  <div id="filter-panel-fixed" class="d-none d-lg-block shadow">
    <h5>Filter Markers</h5>
    <!-- Toggle controls – default checked -->
    <div class="mb-2 form-check">
      <input type="checkbox" id="toggleUSUK" class="form-check-input" checked>
      <label for="toggleUSUK" class="form-check-label">Show US‑UK Cities</label>
    </div>
    <div class="mb-2 form-check">
      <input type="checkbox" id="toggleUSBiblical" class="form-check-input" checked>
      <label for="toggleUSBiblical" class="form-check-label">Show US Biblical Cities</label>
    </div>
    <!-- Testament filter control -->
    <div class="mb-2">
      <strong>Testament:</strong>
      <select id="testamentFilter" class="form-select form-select-sm">
        <option value="both" selected>Both</option>
        <option value="old">Old Testament</option>
        <option value="new">New Testament</option>
      </select>
    </div>
    <!-- State filter panel (all states checked by default) -->
    <div class="mb-2">
      <strong>US States:</strong>
      <div id="us-states-filter"></div>
      <button id="selectAllStates" class="btn btn-sm btn-primary mt-2">Select All States</button>
    </div>
    <!-- Zoom All Button -->
    <div class="mt-2">
      <button id="zoomAllBtn" class="btn btn-sm btn-warning">Zoom to All Markers</button>
    </div>
    <!-- Search Box -->
    <div class="mt-3">
      <label for="citySearch" class="form-label">Search (by group):</label>
      <input type="text" id="citySearch" class="form-control form-control-sm" placeholder="Type to search...">
      <ul id="searchResults"></ul>
    </div>
  </div>

  <!-- Mobile offcanvas filter panel (visible on small screens) -->
  <div class="offcanvas offcanvas-start d-lg-none" tabindex="-1" id="filterPanelOffcanvas" aria-labelledby="filterPanelOffcanvasLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="filterPanelOffcanvasLabel">Filter Markers</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <!-- Mobile controls mirror desktop controls -->
      <div class="mb-2 form-check">
        <input type="checkbox" id="toggleUSUK_mobile" class="form-check-input" checked>
        <label for="toggleUSUK_mobile" class="form-check-label">Show US‑UK Cities</label>
      </div>
      <div class="mb-2 form-check">
        <input type="checkbox" id="toggleUSBiblical_mobile" class="form-check-input" checked>
        <label for="toggleUSBiblical_mobile" class="form-check-label">Show US Biblical Cities</label>
      </div>
      <div class="mb-2">
        <strong>Testament:</strong>
        <select id="testamentFilter_mobile" class="form-select form-select-sm">
          <option value="both" selected>Both</option>
          <option value="old">Old Testament</option>
          <option value="new">New Testament</option>
        </select>
      </div>
      <div class="mb-2">
        <strong>US States:</strong>
        <div id="us-states-filter-mobile"></div>
        <button id="selectAllStates_mobile" class="btn btn-sm btn-primary mt-2">Select All States</button>
      </div>
      <div class="mt-2">
        <button id="zoomAllBtn_mobile" class="btn btn-sm btn-warning">Zoom to All Markers</button>
      </div>
      <div class="mt-3">
        <label for="citySearch_mobile" class="form-label">Search (by group):</label>
        <input type="text" id="citySearch_mobile" class="form-control form-control-sm" placeholder="Type to search...">
        <ul id="searchResults_mobile"></ul>
      </div>
    </div>
  </div>

  <!-- Mobile filter toggle button -->
  <button class="btn btn-primary d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterPanelOffcanvas" aria-controls="filterPanelOffcanvas" style="position: absolute; top: 10px; right: 10px; z-index: 1200;">
    Filters
  </button>

  <!-- Scripts -->
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
  <!-- Leaflet Awesome Markers JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>

  <script>
    /***********************
     * UTILITY FUNCTIONS
     ***********************/
    function cleanPlaceName(name) {
      let cleaned = name.split("/")[0].trim();
      return cleaned.replace(/\s*\d+$/, "");
    }
    function getBaseGroup(name) {
      if (!name) return "";
      let cleaned = name.split("/")[0].trim().toLowerCase();
      cleaned = cleaned.replace(/\s*\d+$/, "");
      cleaned = cleaned.replace(/\(.*\)/, "").trim();
      cleaned = cleaned.replace(/\bbeach\b/g, "").trim();
      return cleaned;
    }
    function titleCase(str) {
      return str.replace(/\w\S*/g, function(txt) {
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
      });
    }
    // Parse CSV coordinate strings; swap order if swap===true.
    function parseCoordinates(coordStr, swap = false) {
      coordStr = coordStr.trim();
      if (!coordStr) return [];
      let pairs = coordStr.split(" ").filter(s => s.trim() !== "");
      return pairs.map(pair => {
        let coords = pair.split(",");
        return swap ? [parseFloat(coords[1]), parseFloat(coords[0])] : [parseFloat(coords[0]), parseFloat(coords[1])];
      });
    }
    function parseFirstCoordinate(coordStr, swap = false) {
      let arr = parseCoordinates(coordStr, swap);
      return (arr.length > 0) ? arr[0] : [0, 0];
    }
    // Normalize Testament values: "old", "new", or "both".
    function normalizeTestament(testament) {
      let t = testament.trim().toLowerCase();
      if (t.indexOf("old") !== -1) return "old";
      if (t.indexOf("new") !== -1) return "new";
      return "both";
    }
    
    /***********************
     * GLOBAL VARIABLES & MAP INITIALIZATION
     ***********************/
    // Initialize the map without adding any markers.
    let map = L.map('map').setView([39.50, -98.35], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      maxZoom: 18
    }).addTo(map);
    
    // Create layer groups for markers.
    const usUkLayerGroup = L.layerGroup();
    const oldBiblicalLayerGroup = L.layerGroup();
    const newBiblicalLayerGroup = L.layerGroup();
    const bothBiblicalLayerGroup = L.layerGroup();
    
    // Popup options. Set closeOnClick and autoClose to false so that once open the popup stays open.
    const popupOptions = {
      maxWidth: 250,
      autoPan: true,
      autoPanPadding: L.point(10, 100),
      offset: L.point(0, -10),
      closeOnClick: false,
      autoClose: false
    };
    
    /***********************
     * GLOBAL ARRAYS & OBJECTS
     ***********************/
    let usUkMarkers = [];      // US/UK markers
    let usBiblicalMarkers = [];  // US Biblical markers
    let usUkLoaded = false;
    let usBiblicalLoaded = false;
    let biblicalDataMap = {};    // keyed by groupKey
    let usStatesSet = new Set();
    
    /***********************
     * ICON DEFINITIONS
     ***********************/
    let iconCityUS = L.AwesomeMarkers.icon({ icon: 'info-sign', markerColor: 'blue', prefix: 'glyphicon' });
    let iconCityUK = L.AwesomeMarkers.icon({ icon: 'info-sign', markerColor: 'red', prefix: 'glyphicon' });
    let iconUSBiblical = L.AwesomeMarkers.icon({ icon: 'info-sign', markerColor: 'purple', prefix: 'glyphicon' });
    let iconBiblical = L.AwesomeMarkers.icon({ icon: 'info-sign', markerColor: 'green', prefix: 'glyphicon' });
    let highlightIcon = L.AwesomeMarkers.icon({ icon: 'star', markerColor: 'orange', prefix: 'glyphicon' });
    
    /*****************************************************
     * URL FILTER FUNCTIONS
     *****************************************************/
    function getInitialFiltersFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return {
        usuk: params.get("usuk") === "1",
        usbiblical: params.get("usbiblical") === "1",
        states: params.get("states")
          ? params.get("states").split(",").map(s => s.trim().toLowerCase())
          : null,
        testament: params.get("testament") ? normalizeTestament(params.get("testament")) : "both"
      };
    }
    function updateUrlWithFilters() {
      const filters = getFilterSettings();
      const params = new URLSearchParams(window.location.search);
      params.set("usuk", filters.toggleUSUK ? "1" : "0");
      params.set("usbiblical", filters.toggleUSBiblical ? "1" : "0");
      params.set("testament", filters.testament);
      if (filters.selectedStates.length > 0) {
        params.set("states", filters.selectedStates.join(","));
      } else {
        params.delete("states");
      }
      history.replaceState(null, "", "?" + params.toString());
    }
    
    /*****************************************************
     * APPLY FILTERS FROM URL ON LOAD
     *****************************************************/
    function applyFiltersFromUrl() {
      const initialFilters = getInitialFiltersFromUrl();
      console.log("Applying filters from URL:", initialFilters);
      // Update desktop toggles.
      const toggleUSUKDesktop = document.getElementById("toggleUSUK");
      const toggleUSBiblicalDesktop = document.getElementById("toggleUSBiblical");
      if (toggleUSUKDesktop) toggleUSUKDesktop.checked = initialFilters.usuk;
      if (toggleUSBiblicalDesktop) toggleUSBiblicalDesktop.checked = initialFilters.usbiblical;
      // Update mobile toggles.
      const toggleUSUKMobile = document.getElementById("toggleUSUK_mobile");
      const toggleUSBiblicalMobile = document.getElementById("toggleUSBiblical_mobile");
      if (toggleUSUKMobile) toggleUSUKMobile.checked = initialFilters.usuk;
      if (toggleUSBiblicalMobile) toggleUSBiblicalMobile.checked = initialFilters.usbiblical;
      // Update Testament select controls.
      const testamentDesktop = document.getElementById("testamentFilter");
      const testamentMobile = document.getElementById("testamentFilter_mobile");
      if (testamentDesktop) testamentDesktop.value = initialFilters.testament;
      if (testamentMobile) testamentMobile.value = initialFilters.testament;
      // Update state checkboxes if a states parameter exists.
      if (initialFilters.states) {
        const stateCheckboxesDesktop = document.querySelectorAll("#us-states-filter input[type=checkbox]");
        stateCheckboxesDesktop.forEach(cb => { cb.checked = initialFilters.states.includes(cb.value.toLowerCase()); });
        const stateCheckboxesMobile = document.querySelectorAll("#us-states-filter-mobile input[type=checkbox]");
        stateCheckboxesMobile.forEach(cb => { cb.checked = initialFilters.states.includes(cb.value.toLowerCase()); });
      }
      updateMarkersVisibility();
    }
    
    /*****************************************************
     * FILTER SETTINGS HELPER
     *****************************************************/
    function getFilterSettings() {
      const usUkDesktop = document.getElementById("toggleUSUK");
      const usUkMobile = document.getElementById("toggleUSUK_mobile");
      const usBiblicalDesktop = document.getElementById("toggleUSBiblical");
      const usBiblicalMobile = document.getElementById("toggleUSBiblical_mobile");
      const toggleUSUK = (usUkDesktop ? usUkDesktop.checked : false) || (usUkMobile ? usUkMobile.checked : false);
      const toggleUSBiblical = (usBiblicalDesktop ? usBiblicalDesktop.checked : false) || (usBiblicalMobile ? usBiblicalMobile.checked : false);
      const testamentFilter = document.getElementById("testamentFilter")
                                ? document.getElementById("testamentFilter").value.toLowerCase()
                                : (document.getElementById("testamentFilter_mobile") ? document.getElementById("testamentFilter_mobile").value.toLowerCase() : "both");
      const stateInputs = document.querySelectorAll("#us-states-filter input[type=checkbox], #us-states-filter-mobile input[type=checkbox]");
      let selectedStates = [];
      stateInputs.forEach(cb => { if (cb.checked) selectedStates.push(cb.value.trim().toLowerCase()); });
      const settings = { toggleUSUK, toggleUSBiblical, selectedStates, testament: testamentFilter };
      console.log("Current filter settings:", settings);
      return settings;
    }
    
    /*****************************************************
     * LAZY CSV LOADING FUNCTIONS
     *****************************************************/
    // Load US‑UK Cities.
    function loadUsUkCities() {
      if (usUkLoaded) return;
      console.log("Loading US–UK Cities...");
      Papa.parse("cities_with_both_coords.csv", {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function(results) {
          console.log("Loaded cities_with_both_coords.csv, rows:", results.data.length);
          results.data.forEach(function(row) {
            let cityName = row["City"] ? row["City"].trim() : "";
            if (!cityName) return;
            let displayLabel = titleCase(cityName);
            let groupKey = getBaseGroup(cityName);
            let country = (row["Country"] || "").toUpperCase();
            let state = row["State"] ? titleCase(row["State"].trim()) : "";
            if (country === "US" && state && state !== "N/A") {
              usStatesSet.add(state.toLowerCase());
            }
            let lat = parseFloat(row["latitude"]);
            let lng = parseFloat(row["longitude"]);
            let label = displayLabel + (state ? " (" + state + ")" : "");
            let iconToUse = (country === "US") ? iconCityUS : iconCityUK;
            let marker = L.marker([lat, lng], { icon: iconToUse });
            marker.myData = { 
              type: "city", 
              label: label, 
              displayLabel: displayLabel, 
              country: country, 
              state: state, 
              lat: lat, 
              lng: lng, 
              groupKey: groupKey, 
              frozen: false 
            };
            // Prevent toggling popup on repeated clicks.
            marker.on('click', function() {
              if (!this.isPopupOpen()) {
                showCityPopup(this);
              }
            });
            usUkMarkers.push(marker);
          });
          usUkLoaded = true;
          console.log("US–UK markers loaded:", usUkMarkers.length);
          buildFilterPanel();
          updateMarkersVisibility();
        },
        error: function(err) { console.error("Error loading cities_with_both_coords.csv:", err); }
      });
    }
    
    // Load US Biblical Cities from processed_biblical_places_sorted.csv.
    function loadUsBiblicalCities() {
      if (usBiblicalLoaded) return;
      console.log("Loading US Biblical Cities...");
      Papa.parse("processed_biblical_places_sorted.csv", {
        download: true,
        header: true,
        complete: function(results) {
          console.log("Loaded processed_biblical_places_sorted.csv, rows:", results.data.length);
          results.data.forEach(function(row) {
            let placeName = row["Place Name"] ? row["Place Name"].trim() : "";
            if (!placeName) return;
            let displayLabel = titleCase(placeName);
            let groupKey = getBaseGroup(placeName);
            if (!biblicalDataMap[groupKey]) {
              let coordsStr = row["Coordinates"] ? row["Coordinates"].trim() : "";
              let parsedCoords = parseCoordinates(coordsStr, true); // CSV stores long,lat
              if (parsedCoords.length > 0) {
                let point = (parsedCoords.length >= 3)
                  ? (function() {
                      let sum = parsedCoords.reduce((acc, pair) => [acc[0] + pair[0], acc[1] + pair[1]], [0, 0]);
                      return [sum[0] / parsedCoords.length, sum[1] / parsedCoords.length];
                    })()
                  : parsedCoords[0];
                let biblicalReferences = row["Sorted Biblical References"] ? row["Sorted Biblical References"].trim() : "";
                let testament = row["Testament"] ? row["Testament"].trim() : "Both";
                biblicalDataMap[groupKey] = { 
                  lat: point[0], 
                  lng: point[1], 
                  polygon: (parsedCoords.length >= 3 ? parsedCoords : null), 
                  biblicalReferences: biblicalReferences,
                  testament: testament
                };
                console.log("Stored biblical data for group:", groupKey, biblicalDataMap[groupKey]);
              }
            }
            // Process the "US Matching Cities" column.
            let usMatchesRaw = row["US Matching Cities"] ? row["US Matching Cities"].trim() : "";
            let usMatches = usMatchesRaw.split(";").map(s => s.trim()).filter(s => s !== "");
            usMatches.forEach(function(matchStr) {
              let parts = matchStr.split(":");
              if (parts.length < 2) return;
              let matchLabel = parts[0].trim();
              let stateMatch = matchLabel.match(/\(([^)]+)\)/);
              let state = stateMatch ? titleCase(stateMatch[1].trim()) : "";
              if (!state || state.toUpperCase() === "N/A") {
                console.log("Skipping US Biblical marker for label due to missing state:", matchLabel);
                return;
              }
              usStatesSet.add(state.toLowerCase());
              let coordPart = parts[1].trim();
              let latlngArr = coordPart.split(",");
              if (latlngArr.length < 2) return;
              let lat = parseFloat(latlngArr[0]);
              let lng = parseFloat(latlngArr[1]);
              let displayMatchLabel = titleCase(matchLabel);
              let marker = L.marker([lat, lng], { icon: iconUSBiblical });
              let biblicalReferences = row["Sorted Biblical References"] ? row["Sorted Biblical References"].trim() : "";
              let testament = row["Testament"] ? row["Testament"].trim() : "Both";
              marker.myData = { 
                type: "usBiblical", 
                label: displayMatchLabel, 
                state: state, 
                lat: lat, 
                lng: lng, 
                groupKey: groupKey, 
                biblicalReferences: biblicalReferences,
                testament: testament,
                frozen: false 
              };
              // Prevent toggling popup on repeated clicks.
              marker.on('click', function() {
                if (!this.isPopupOpen()) {
                  showBiblicalPopup(this);
                }
              });
              // Listen for popupclose but do not call updateMarkersVisibility() here.
              marker.on('popupclose', function() {
                console.log("Popup closed for biblical marker:", this.myData.label);
                this.myData.frozen = false;
              });
              usBiblicalMarkers.push(marker);
            });
          });
          usBiblicalLoaded = true;
          console.log("US Biblical markers loaded:", usBiblicalMarkers.length);
          buildFilterPanel();
          updateMarkersVisibility();
        },
        error: function(err) { console.error("Error loading processed_biblical_places_sorted.csv:", err); }
      });
    }
    
    /*****************************************************
     * POPUP BUILDERS (popups open immediately)
     *****************************************************/
     function showCityPopup(marker) {
  if (marker.isPopupOpen()) return;

  let d = marker.myData;
  let stateDisplay = (d.country === "US" && d.state && d.state.toUpperCase()!== "N/A")? d.state: "";
  let content = "<strong>" + d.displayLabel + "</strong><br>";
  if (stateDisplay) { content += "State: " + stateDisplay + "<br>"; }
  content += "Country: " + d.country + "<br>";
  let similar = usUkMarkers.filter(m => m.myData.groupKey.indexOf(d.groupKey)!== -1);
  if (similar.length > 0) {
    content += "<u>Matching Cities:</u><br>";
    similar.forEach(m => {
      let dd = m.myData;
      if (dd.country === "US" && (!dd.state || dd.state.toUpperCase() === "N/A")) return;
      content += dd.displayLabel + " (" + dd.country + ")<br>" +
                 "<button class='btn btn-sm btn-secondary mt-1' onclick='flyToLocation(" + dd.lat + ", " + dd.lng + ", \"" + dd.displayLabel.replace(/"/g, '\\\"') + "\", \"City-" + dd.country + "\")'>Fly to City (" + dd.country + ")</button><br>";
    });
  }

  marker.off('click');
  marker.bindPopup(content, popupOptions).openPopup();

  marker.on('popupclose', function() {
    marker.on('click', function() {
      if (!this.isPopupOpen()) {
        showCityPopup(this);
      }
    });
  });

  const popup = marker.getPopup();
  if (popup) {
    popup.on('close', function() {
      marker.on('click', function() {
        if (!this.isPopupOpen()) {
          showCityPopup(this);
        }
      });
    });
  }
  if (typeof sefaria!== "undefined" && sefaria.link) {
    sefaria.link({ dynamic: true });
  }
}
    
function showBiblicalPopup(marker) {
  if (marker.isPopupOpen()) return;

  let d = marker.myData;
  let content = "<strong>" + d.label + "</strong><br>";
  if (d.biblicalReferences) {
    content += "Biblical References: " + d.biblicalReferences + "<br>";
  }
  let similar = usBiblicalMarkers.filter(m => m.myData.groupKey === d.groupKey && m.myData.state && m.myData.state.toUpperCase()!== "N/A");
  if (similar.length > 0) {
    content += "<u>US Matching Cities:</u><br>";
    similar.forEach(m => {
      let dd = m.myData;
      content += dd.label + " (State: " + dd.state + ")<br>" +
                 "<button class='btn btn-sm btn-primary mt-1' onclick='flyToLocation(" + dd.lat + ", " + dd.lng + ", \"" + dd.label.replace(/"/g, '\\\"') + "\", \"US Biblical\")'>Fly to US Biblical</button><br>";
    });
  }
  content += "<br><button class='btn btn-sm btn-success' onclick='flyToBiblicalPlace(\"" + d.groupKey + "\")'>Fly to Biblical Place</button>";

  marker.off('click');
  marker.bindPopup(content, popupOptions).openPopup();

  marker.on('popupclose', function() {
    marker.on('click', function() {
      if (!this.isPopupOpen()) {
        showBiblicalPopup(this);
      }
    });
  });

  const popup = marker.getPopup();
  if (popup) {
    popup.on('close', function() {
      marker.on('click', function() {
        if (!this.isPopupOpen()) {
          showBiblicalPopup(this);
        }
      });
    });
  }
  if (typeof sefaria!== "undefined" && sefaria.link) {
    sefaria.link({ dynamic: true });
  }
}
    
    function flyToCityView(groupKey) {
      let marker = usUkMarkers.find(m => m.myData.groupKey === groupKey);
      if (marker) {
        map.flyTo(marker.getLatLng(), 10, { duration: 1.5 });
        marker.openPopup();
      } else {
        alert("No US/UK city marker found for group: " + groupKey);
      }
    }
    
    // When flying to a marker, change its icon for 2 seconds, fly to it, and then open its popup.
    function flyToLocation(lat, lng, name, type) {
  let groupKey = getBaseGroup(name);
  let foundMarker = null;
  if (type.startsWith("City-")) {
    let desiredCountry = type.split("-");
    foundMarker = usUkMarkers.find(m => m.myData.groupKey === groupKey && m.myData.country === desiredCountry);
    if (!foundMarker) {
      foundMarker = usUkMarkers.find(m => m.myData.groupKey.indexOf(groupKey)!== -1);
    }
  } else if (type === "US Biblical") {
    foundMarker = usBiblicalMarkers.find(m => m.myData.groupKey === groupKey);
  }

  if (foundMarker) {
    console.log("Fly-to found marker:", foundMarker.myData.label);
    foundMarker.off('click');

    map.flyTo(foundMarker.getLatLng(), 10, { duration: 1.5 });

    setTimeout(() => {
      if (!foundMarker.isPopupOpen()) {
        if (foundMarker.myData.type === 'city') {
          showCityPopup(foundMarker);
        } else {
          showBiblicalPopup(foundMarker);
        }
        console.log("Fly-to popup opened for:", foundMarker.myData.label);
      }
    }, 1500);

    setTimeout(() => {
      foundMarker.on('click', function() {
        if (!this.isPopupOpen()) {
          if (this.myData.type === 'city') {
            showCityPopup(this);
          } else {
            showBiblicalPopup(this);
          }
        }
      });
    }, 2000);

    foundMarker.on('popupclose', function() {
        foundMarker.on('click', function() {
          if (!this.isPopupOpen()) {
             if (this.myData.type === 'city') {
              showCityPopup(this);
            } else {
              showBiblicalPopup(this);
            }
          }
        });
    });
        const popup = foundMarker.getPopup();
        if (popup) {
          popup.on('close', function() {
             foundMarker.on('click', function() {
              if (!this.isPopupOpen()) {
                if (this.myData.type === 'city') {
                  showCityPopup(this);
                } else {
                  showBiblicalPopup(this);
                }
              }
            });
          });
        }

  } else {
    console.log("No marker found for fly-to, creating temporary marker for:", name);
    let tempIcon = (type.startsWith("City-"))
    ? ((type.split("-") === "UK")? iconCityUK: iconCityUS)
    : (type === "US Biblical"? iconUSBiblical: iconBiblical);
    let tempMarker = L.marker([lat, lng], { icon: highlightIcon }).addTo(map);
    tempMarker.myData = { type: type, label: name, lat: lat, lng: lng, groupKey: groupKey };
    map.flyTo([lat, lng], 10, { duration: 1.5 });
    setTimeout(() => {
      tempMarker.openPopup();
      console.log("Temporary marker popup opened for:", name);
      map.removeLayer(tempMarker);
    }, 2000);
  }
  console.log("Flying to " + name + " (" + type + ") with groupKey: " + groupKey + " at " + lat + ", " + lng);
}
window.flyToLocation = flyToLocation;
    
    function flyToBiblicalPlace(groupKey) {
      let bib = biblicalDataMap[groupKey];
      if (bib) {
        let existing = usBiblicalMarkers.find(m => m.myData.groupKey === groupKey && m.myData.type === "Biblical");
        if (!existing) {
          let marker = L.marker([bib.lat, bib.lng], { icon: iconBiblical }).addTo(map);
          let biblicalRefs = bib.biblicalReferences ? bib.biblicalReferences : "";
          marker.myData = { type: "Biblical", label: titleCase(groupKey), biblicalReferences: biblicalRefs, lat: bib.lat, lng: bib.lng, groupKey: groupKey, frozen: true };
          marker.on('click', function() { showBiblicalPopup(this); });
          marker.on('popupclose', function() {
            console.log("Biblical popup closed for:", this.myData.label);
            this.myData.frozen = false;
            updateMarkersVisibility();
          });
          usBiblicalMarkers.push(marker);
          existing = marker;
          console.log("Created new biblical marker for group:", groupKey);
        }
        if (bib.polygon) {
          let poly = L.polygon(bib.polygon, { color: "green", weight: 3 }).addTo(map);
          setTimeout(() => { map.removeLayer(poly); }, 2000);
        }
        map.flyTo([bib.lat, bib.lng], 10, { duration: 1.5 });
        setTimeout(() => {
          existing.openPopup();
          console.log("Biblical fly-to popup opened for:", existing.myData.label);
        }, 2000);
      } else {
        alert("Biblical place data not found for group: " + groupKey);
      }
    }
    
    /*****************************************************
     * UPDATE MARKERS BASED ON FILTERS
     *****************************************************/
    function updateMarkersVisibility() {
      const filters = getFilterSettings();
      
      // Load markers if necessary.
      if (filters.toggleUSUK && !usUkLoaded) { loadUsUkCities(); }
      if (filters.toggleUSBiblical && !usBiblicalLoaded) { loadUsBiblicalCities(); }
      
      // Clear all layer groups.
      usUkLayerGroup.clearLayers();
      oldBiblicalLayerGroup.clearLayers();
      newBiblicalLayerGroup.clearLayers();
      bothBiblicalLayerGroup.clearLayers();
      
      // Add US‑UK markers if the US‑UK toggle is checked.
      if (filters.toggleUSUK) {
        usUkMarkers.forEach(m => {
          let d = m.myData;
          // If state filtering is in effect and marker's state is not among selected states, skip it.
          if (d.country === "US" && filters.selectedStates.length > 0 && d.state && filters.selectedStates.indexOf(d.state.toLowerCase()) === -1) {
            return;
          }
          usUkLayerGroup.addLayer(m);
        });
      }
      
      // Add US Biblical markers if the toggle is checked and they pass the state and Testament filters.
      if (filters.toggleUSBiblical) {
        usBiblicalMarkers.forEach(m => {
          let d = m.myData;
          if (d.state && filters.selectedStates.length > 0 && filters.selectedStates.indexOf(d.state.toLowerCase()) === -1) return;
          let markerTestament = normalizeTestament(d.testament || "Both");
          if (filters.testament !== "both" && markerTestament !== filters.testament) return;
          if (markerTestament === "old") {
            oldBiblicalLayerGroup.addLayer(m);
          } else if (markerTestament === "new") {
            newBiblicalLayerGroup.addLayer(m);
          } else {
            bothBiblicalLayerGroup.addLayer(m);
          }
        });
      }
      
      // Add layer groups to the map.
      if (filters.toggleUSUK) { usUkLayerGroup.addTo(map); } else { map.removeLayer(usUkLayerGroup); }
      if (filters.toggleUSBiblical) {
        oldBiblicalLayerGroup.addTo(map);
        newBiblicalLayerGroup.addTo(map);
        bothBiblicalLayerGroup.addTo(map);
      } else {
        map.removeLayer(oldBiblicalLayerGroup);
        map.removeLayer(newBiblicalLayerGroup);
        map.removeLayer(bothBiblicalLayerGroup);
      }
    }
    
    /*****************************************************
     * BUILD FILTER PANEL (state checkboxes default to checked)
     *****************************************************/
    function buildFilterPanel() {
      const initialFilters = getInitialFiltersFromUrl();
      let container = document.getElementById("us-states-filter");
      container.innerHTML = "";
      let states = Array.from(usStatesSet).sort();
      console.log("Building desktop filter panel with states:", states);
      states.forEach(state => {
        let checkboxId = "state-" + state.replace(/\s+/g, "_");
        let checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = checkboxId;
        checkbox.value = state;
        // Default: if no URL filter exists, check all.
        checkbox.checked = initialFilters.states ? initialFilters.states.includes(state.toLowerCase()) : true;
        checkbox.addEventListener("change", () => { updateUrlWithFilters(); updateMarkersVisibility(); });
        container.appendChild(checkbox);
        let label = document.createElement("label");
        label.htmlFor = checkboxId;
        label.innerText = " " + titleCase(state);
        container.appendChild(label);
        let onlyBtn = document.createElement("button");
        onlyBtn.type = "button";
        onlyBtn.className = "btn btn-sm btn-link ms-1";
        onlyBtn.innerText = "Only";
        onlyBtn.addEventListener("click", function() {
          let inputs = container.querySelectorAll("input[type=checkbox]");
          inputs.forEach(inp => { inp.checked = false; });
          checkbox.checked = true;
          updateUrlWithFilters();
          updateMarkersVisibility();
        });
        container.appendChild(onlyBtn);
        container.appendChild(document.createElement("br"));
      });
      document.getElementById("selectAllStates").addEventListener("click", function() {
        let inputs = container.querySelectorAll("input[type=checkbox]");
        inputs.forEach(inp => { inp.checked = true; });
        updateUrlWithFilters();
        updateMarkersVisibility();
      });
      
      // Build mobile panel by cloning the desktop version.
      let mobileContainer = document.getElementById("us-states-filter-mobile");
      if (mobileContainer) {
        mobileContainer.innerHTML = container.innerHTML;
        mobileContainer.querySelectorAll("input[type=checkbox]").forEach(checkbox => {
          checkbox.addEventListener("change", () => { updateUrlWithFilters(); updateMarkersVisibility(); });
        });
        document.getElementById("selectAllStates_mobile").addEventListener("click", function() {
          mobileContainer.querySelectorAll("input[type=checkbox]").forEach(inp => { inp.checked = true; });
          updateUrlWithFilters();
          updateMarkersVisibility();
        });
      }
    }
    
    /*****************************************************
     * SET UP CITY SEARCH (desktop and mobile)
     *****************************************************/
    function setupCitySearch() {
      let searchInput = document.getElementById("citySearch");
      let resultsList = document.getElementById("searchResults");
      searchInput.addEventListener("input", function() {
        let query = this.value.toLowerCase().trim();
        resultsList.innerHTML = "";
        if (!query) { resultsList.style.display = "none"; return; }
        let matches = new Set();
        usUkMarkers.forEach(m => {
          if (m.myData.groupKey.indexOf(query) !== -1 || m.myData.label.toLowerCase().indexOf(query) !== -1) {
            matches.add(m.myData.groupKey);
          }
        });
        usBiblicalMarkers.forEach(m => {
          if (m.myData.groupKey.indexOf(query) !== -1 || m.myData.label.toLowerCase().indexOf(query) !== -1) {
            matches.add(m.myData.groupKey);
          }
        });
        matches = Array.from(matches);
        if (matches.length > 0) {
          matches.slice(0, 20).forEach(match => {
            let li = document.createElement("li");
            li.innerText = titleCase(match);
            li.onclick = function() {
              let marker = usBiblicalMarkers.find(m => m.myData.groupKey === match) ||
                           usUkMarkers.find(m => m.myData.groupKey === match);
              if (marker) {
                map.flyTo(marker.getLatLng(), 10, { duration: 1.5 });
                marker.openPopup();
              }
              resultsList.style.display = "none";
              searchInput.value = "";
            };
            resultsList.appendChild(li);
          });
          resultsList.style.display = "block";
        } else {
          resultsList.style.display = "none";
        }
      });
      
      let searchInputMobile = document.getElementById("citySearch_mobile");
      let resultsListMobile = document.getElementById("searchResults_mobile");
      if (searchInputMobile) {
        searchInputMobile.addEventListener("input", function() {
          let query = this.value.toLowerCase().trim();
          resultsListMobile.innerHTML = "";
          if (!query) { resultsListMobile.style.display = "none"; return; }
          let matches = new Set();
          usUkMarkers.forEach(m => {
            if (m.myData.groupKey.indexOf(query) !== -1 || m.myData.label.toLowerCase().indexOf(query) !== -1) {
              matches.add(m.myData.groupKey);
            }
          });
          usBiblicalMarkers.forEach(m => {
            if (m.myData.groupKey.indexOf(query) !== -1 || m.myData.label.toLowerCase().indexOf(query) !== -1) {
              matches.add(m.myData.groupKey);
            }
          });
          matches = Array.from(matches);
          if (matches.length > 0) {
            matches.slice(0, 20).forEach(match => {
              let li = document.createElement("li");
              li.innerText = titleCase(match);
              li.onclick = function() {
                let marker = usBiblicalMarkers.find(m => m.myData.groupKey === match) ||
                             usUkMarkers.find(m => m.myData.groupKey === match);
                if (marker) {
                  map.flyTo(marker.getLatLng(), 10, { duration: 1.5 });
                  marker.openPopup();
                }
                resultsListMobile.style.display = "none";
                searchInputMobile.value = "";
              };
              resultsListMobile.appendChild(li);
            });
            resultsListMobile.style.display = "block";
          } else {
            resultsListMobile.style.display = "none";
          }
        });
      }
    }
    
    function zoomToAllMarkers() {
      let bounds = L.latLngBounds([]);
      usUkMarkers.forEach(m => { if (map.hasLayer(m)) bounds.extend(m.getLatLng()); });
      usBiblicalMarkers.forEach(m => { if (map.hasLayer(m)) bounds.extend(m.getLatLng()); });
      if (bounds.isValid()) { map.fitBounds(bounds); }
      else { console.log("No markers in bounds to zoom to."); }
    }
    document.getElementById("zoomAllBtn").addEventListener("click", zoomToAllMarkers);
    if (document.getElementById("zoomAllBtn_mobile")) {
      document.getElementById("zoomAllBtn_mobile").addEventListener("click", zoomToAllMarkers);
    }
    
    /*****************************************************
     * EVENT LISTENERS FOR FILTER CONTROLS
     *****************************************************/
    document.getElementById("toggleUSUK").addEventListener("change", () => { updateMarkersVisibility(); updateUrlWithFilters(); });
    document.getElementById("toggleUSBiblical").addEventListener("change", () => { updateMarkersVisibility(); updateUrlWithFilters(); });
    if (document.getElementById("toggleUSUK_mobile")) {
      document.getElementById("toggleUSUK_mobile").addEventListener("change", () => { updateMarkersVisibility(); updateUrlWithFilters(); });
    }
    if (document.getElementById("toggleUSBiblical_mobile")) {
      document.getElementById("toggleUSBiblical_mobile").addEventListener("change", () => { updateMarkersVisibility(); updateUrlWithFilters(); });
    }
    document.getElementById("testamentFilter").addEventListener("change", () => { updateMarkersVisibility(); updateUrlWithFilters(); });
    if (document.getElementById("testamentFilter_mobile")) {
      document.getElementById("testamentFilter_mobile").addEventListener("change", () => { updateMarkersVisibility(); updateUrlWithFilters(); });
    }
    
    /*****************************************************
     * INITIAL UI SETUP
     *****************************************************/
    buildFilterPanel();
    setupCitySearch();
    document.addEventListener("DOMContentLoaded", applyFiltersFromUrl);
  </script>
  
  <!-- Sefaria Linker Script (uses POST internally) -->
  <script type="text/javascript" charset="utf-8" src="https://www.sefaria.org/linker.v3.js"></script>
  <script>
    // Initialize the Sefaria Linker in popup-click mode with dynamic content.
    sefaria.link({ mode: "popup-click", dynamic: true });
  </script>
</body>
</html>
